{% extends "layout.html" %}
{% block content %}
<h2>Zarządzanie Studentami</h2>

<div class="mb-3">
    <button class="btn btn-primary" onclick="openAddModal()">Dodaj Studenta</button>

    <button class="btn btn-success" onclick="document.getElementById('importFile').click()">
        <i class="bi bi-file-earmark-excel"></i> Importuj z Excel (.xlsx)
    </button>
</div>

<form id="importForm" action="{{ url_for('admin.import_students') }}" method="POST" enctype="multipart/form-data"
    style="display: none;">
    <input type="file" name="file" id="importFile" accept=".xlsx"
        onchange="document.getElementById('importForm').submit()">
</form>

<div class="card shadow">
    <div class="card-body">
        <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th>Imię</th>
                    <th>Indeks</th>
                    <th>Kierunek</th>
                    <th>Wydział</th>
                    <th>Dział</th>
                    <th>Akcja</th>
                </tr>
            </thead>
            <tbody>
                {% for s in students %}
                <tr id="student-row-{{ s.id }}" data-name="{{ s.name }}" data-index="{{ s.index }}"
                    data-major="{{ s.major }}" data-gender="{{ s.gender }}" data-faculty="{{ s.faculty }}"
                    data-department="{{ s.department }}">
                    <td>{{ s.name }}</td>
                    <td>{{ s.index }}</td>
                    <td>{{ s.major }}</td>
                    <td>{{ s.faculty }}</td>
                    <td>{{ s.department }}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm"
                            onclick="prepareEdit('{{ s.id }}')">Edytuj</button>
                        <a href="{{ url_for('admin.delete_student', id=s.id) }}" class="btn btn-outline-danger btn-sm"
                            onclick="return confirm('Usunąć studenta?')">Usuń</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="POST" class="modal-content" id="studentForm">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nowy Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="student_id" id="student_id">

                <label class="form-label">Imię i Nazwisko</label>
                <input type="text" name="name" id="name" class="form-control mb-2" required>

                <label class="form-label">Nr Indeksu</label>
                <input type="text" name="index" id="index" class="form-control mb-2" required>

                <label class="form-label">Kierunek</label>
                <input type="text" name="major" id="major" class="form-control mb-2" required>

                <label class="form-label">Płeć</label>
                <select name="gender" id="gender" class="form-select mb-2">
                    <option value="male">Mężczyzna</option>
                    <option value="female">Kobieta</option>
                </select>

                <label class="form-label">Wydział</label>
                <select name="faculty" id="faculty" class="form-select mb-2" required>
                    {% for code, full_name in faculties %}
                    <option value="{{ code }}">{{ full_name }} ({{ code }})</option>
                    {% endfor %}
                </select>

                <label class="form-label">Dział w kole</label>
                <select name="department" id="department" class="form-select mb-2" required>
                    {% for d in departments %}
                    <option value="{{ d }}">{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Zapisz</button>
            </div>
        </form>
    </div>
</div>

<script>
    var studentModalInstance = null;

    document.addEventListener('DOMContentLoaded', function () {
        var modalEl = document.getElementById('studentModal');
        if (modalEl && typeof bootstrap !== 'undefined') {
            studentModalInstance = new bootstrap.Modal(modalEl);
        }
    });

    function openAddModal() {
        document.getElementById('studentForm').reset();
        document.getElementById('student_id').value = '';
        document.getElementById('modalTitle').innerText = 'Nowy Student';
        if (studentModalInstance) studentModalInstance.show();
    }

    function prepareEdit(id) {
        var row = document.getElementById('student-row-' + id);
        document.getElementById('student_id').value = id;
        document.getElementById('name').value = row.getAttribute('data-name');
        document.getElementById('index').value = row.getAttribute('data-index');
        document.getElementById('major').value = row.getAttribute('data-major');
        document.getElementById('gender').value = row.getAttribute('data-gender');
        document.getElementById('faculty').value = row.getAttribute('data-faculty');
        document.getElementById('department').value = row.getAttribute('data-department');

        document.getElementById('modalTitle').innerText = 'Edytuj Studenta';
        if (studentModalInstance) studentModalInstance.show();
    }
</script>
{% endblock %}